# BlackPiyan 架構設計

本文檔描述 BlackPiyan 的架構設計、模塊組織和代碼結構，旨在幫助開發者理解項目的整體設計思路和技術選擇。

## 目錄

1. [整體架構](#整體架構)
2. [目錄結構](#目錄結構)
3. [模塊詳解](#模塊詳解)
4. [數據流](#數據流)
5. [設計模式](#設計模式)
6. [擴展指南](#擴展指南)

## 整體架構

BlackPiyan 採用模塊化架構，遵循單一職責原則，分離了遊戲邏輯、模擬引擎、數據分析和可視化等功能。系統整體架構如下：

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│                 │     │                 │     │                 │
│  遊戲邏輯層     │────►│  模擬引擎層     │────►│  數據分析層     │
│  (Game Logic)   │     │  (Simulation)   │     │  (Analysis)     │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         ▲                                              │
         │                                              │
         │                                              ▼
┌─────────────────┐                        ┌─────────────────┐
│                 │                        │                 │
│  配置管理       │◄───────────────────────┤  可視化層       │
│  (Config)       │                        │  (Visualization)│
│                 │                        │                 │
└─────────────────┘                        └─────────────────┘
```

主要模塊及其功能：

1. **配置管理**：加載、驗證和管理程序配置
2. **遊戲邏輯**：實現21點遊戲的核心規則和邏輯
3. **模擬引擎**：基於遊戲邏輯執行大批量模擬
4. **數據分析**：處理和分析模擬結果數據
5. **可視化**：生成各種圖表以可視化分析結果

## 目錄結構

BlackPiyan 的目錄結構採用功能導向的組織方式：

```
blackpiyan/
├── __init__.py                # 包初始化文件
├── __main__.py                # 主入口點 (支持 python -m blackpiyan)
├── analysis/                  # 數據分析模塊
│   ├── __init__.py
│   └── analyzer.py            # 分析器實現
├── config/                    # 配置管理模塊
│   ├── __init__.py
│   └── config_manager.py      # 配置管理器實現
├── game/                      # 遊戲邏輯模塊
│   ├── __init__.py
│   └── blackjack.py           # 21點遊戲實現
├── model/                     # 數據模型
│   ├── __init__.py
│   ├── card.py                # 撲克牌模型
│   ├── dealer.py              # 莊家模型
│   └── deck.py                # 牌組模型
├── simulation/                # 模擬引擎模塊
│   ├── __init__.py
│   └── simulator.py           # 模擬器實現
├── utils/                     # 實用工具
│   ├── __init__.py
│   └── logger.py              # 日誌工具
└── visualization/             # 可視化模塊
    ├── __init__.py
    └── visualizer.py          # 視覺化器實現

configs/                       # 配置文件目錄
├── default.yaml               # 默認配置

docs/                          # 文檔目錄
├── README.md                  # 文檔索引
├── api_reference.md           # API 參考
├── architecture.md            # 架構設計 (本文檔)
└── ...                        # 其他文檔

results/                       # 輸出結果目錄
├── charts/                    # 圖表輸出目錄
└── data/                      # 數據輸出目錄

tests/                         # 測試目錄
└── ...                        # 測試文件

main.py                        # 應用程序入口
setup.py                       # 安裝腳本
requirements.txt               # 依賴項列表
.gitignore                     # Git 忽略文件
```

## 模塊詳解

### 配置管理 (config)

配置管理模塊負責加載、解析和驗證 YAML 格式的配置文件，並將配置提供給其他模塊使用。主要功能：

- 加載配置文件
- 驗證配置有效性
- 提供默認配置項
- 集中管理配置參數

### 遊戲邏輯 (game)

遊戲邏輯模塊實現了 21 點遊戲的規則和邏輯，包括：

- 莊家補牌策略
- 牌面點數計算
- 爆牌判定
- 牌組管理 (洗牌、發牌)

### 數據模型 (model)

數據模型模塊定義了系統中的核心數據結構：

- **Card**：表示一張撲克牌，包含點數和花色
- **Deck**：表示一副或多副撲克牌，管理洗牌和發牌
- **Dealer**：表示莊家，實現莊家的決策邏輯

### 模擬引擎 (simulation)

模擬引擎基於遊戲邏輯執行大量模擬，收集結果數據：

- 支持單一策略模擬
- 支持多策略對比模擬
- 可配置模擬局數
- 收集詳細的遊戲結果數據

### 數據分析 (analysis)

數據分析模塊處理模擬結果，計算各種統計數據：

- 點數分布統計
- 爆牌率計算
- 不同策略的對比分析
- 統計數據的摘要和整理

### 可視化 (visualization)

可視化模塊將分析結果轉化為直觀的圖表：

- 點數分布圖表
- 策略比較圖表
- 自定義樣式和字體配置
- 圖表導出和保存

### 實用工具 (utils)

實用工具模塊提供跨模塊共享的功能：

- 日誌記錄
- 性能監控
- 時間測量

## 數據流

BlackPiyan 的數據流如下：

1. **配置加載**：從 YAML 文件加載配置參數
2. **遊戲模擬**：
   - 創建牌組和莊家
   - 根據策略執行多局遊戲
   - 收集每局遊戲結果
3. **數據分析**：
   - 計算統計指標 (平均值、中位數、爆牌率等)
   - 生成點數分布數據
   - 比較不同策略
4. **可視化**：
   - 使用分析結果生成圖表
   - 根據配置應用字體和樣式
   - 保存圖表到文件

## 設計模式

BlackPiyan 運用了以下設計模式：

1. **單一職責原則**：每個模塊和類都有明確的責任和功能界限
2. **依賴注入**：通過構造函數傳遞依賴，而非直接創建
3. **策略模式**：莊家的補牌策略可以靈活配置和切換
4. **工廠模式**：在某些地方使用工廠方法創建對象
5. **門面模式**：高層模塊提供簡化的接口隱藏底層複雜性

## 擴展指南

### 添加新的莊家策略

1. 在 `blackpiyan.model.dealer.py` 中擴展 `Dealer` 類
2. 實現新的決策邏輯方法
3. 在配置文件中增加相應的策略參數

### 添加新的分析指標

1. 在 `blackpiyan.analysis.analyzer.py` 中添加新的分析方法
2. 在 `calculate_statistics` 或 `compare_strategies` 方法中使用新指標
3. 更新可視化模塊以展示新指標

### 添加新的圖表類型

1. 在 `blackpiyan.visualization.visualizer.py` 中添加新的繪圖方法
2. 使用 matplotlib 或 seaborn 創建新的圖表類型
3. 更新主程序以調用新的繪圖方法

### 支持新的配置選項

1. 在 `configs/default.yaml` 中添加新的配置參數
2. 在 `blackpiyan.config.config_manager.py` 中更新配置驗證邏輯
3. 在相關模塊中使用新的配置參數

---

本架構文檔旨在提供 BlackPiyan 項目的高層次概述。更多技術細節請參考 [API 參考文檔](./api_reference.md) 和代碼註釋。 